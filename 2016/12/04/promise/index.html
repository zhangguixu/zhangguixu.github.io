<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="异步编程," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="在Promise之前，在js中的异步编程都是采用回调函数和事件的方式，但是这种编程方式在处理复杂业务的情况下，很容易出现callback hell(回调地狱)，使得代码很难被理解和维护。
Promise就是改善这种情形的异步编程的解决方案，它由社区最早提出和实现，es6将其写进了语言标准，统一了用法，并且提供了一个原生的对象Promise。">
<meta property="og:type" content="article">
<meta property="og:title" content="es6系列-promise">
<meta property="og:url" content="https://zhangguixu.github.io/2016/12/04/promise/index.html">
<meta property="og:site_name" content="Zhangguixu's Blogs">
<meta property="og:description" content="在Promise之前，在js中的异步编程都是采用回调函数和事件的方式，但是这种编程方式在处理复杂业务的情况下，很容易出现callback hell(回调地狱)，使得代码很难被理解和维护。
Promise就是改善这种情形的异步编程的解决方案，它由社区最早提出和实现，es6将其写进了语言标准，统一了用法，并且提供了一个原生的对象Promise。">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-01.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-state.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-02.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-resolve.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-03.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-04.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-05.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-06.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-07.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-08.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-10.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-11.png">
<meta property="og:image" content="https://zhangguixu.github.io/uploads/promise-example-09.png">
<meta property="og:updated_time" content="2016-12-03T12:37:11.478Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="es6系列-promise">
<meta name="twitter:description" content="在Promise之前，在js中的异步编程都是采用回调函数和事件的方式，但是这种编程方式在处理复杂业务的情况下，很容易出现callback hell(回调地狱)，使得代码很难被理解和维护。
Promise就是改善这种情形的异步编程的解决方案，它由社区最早提出和实现，es6将其写进了语言标准，统一了用法，并且提供了一个原生的对象Promise。">
<meta name="twitter:image" content="https://zhangguixu.github.io/uploads/promise-example-01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '6357877092683613000',
      author: 'Admin'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhangguixu.github.io/2016/12/04/promise/"/>





  <title> es6系列-promise | Zhangguixu's Blogs </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=59687072";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Zhangguixu's Blogs</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">the load to full-stack</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhangguixu.github.io/2016/12/04/promise/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="zhangguixu">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/uploads/avatar.jpeg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Zhangguixu's Blogs">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Zhangguixu's Blogs" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                es6系列-promise
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-04T04:31:22+08:00">
                2016-12-03
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/" itemprop="url" rel="index">
                    <span itemprop="name">javascript</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/javascript/es6/" itemprop="url" rel="index">
                    <span itemprop="name">es6</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/04/promise/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/04/promise/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-eye"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>在Promise之前，在js中的异步编程都是采用回调函数和事件的方式，但是这种编程方式在处理复杂业务的情况下，很容易出现<code>callback hell(回调地狱)</code>，使得代码很难被理解和维护。</p>
<p>Promise就是改善这种情形的异步编程的解决方案，它由社区最早提出和实现，es6将其写进了语言标准，统一了用法，并且提供了一个原生的对象<code>Promise</code>。</p>
<a id="more"></a>
<h2 id="1-理解Promise"><a href="#1-理解Promise" class="headerlink" title="1. 理解Promise"></a>1. 理解Promise</h2><p>我们通过一个简单例子先来感受一下Promise。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    <span class="keyword">if</span>(<span class="comment">/* 异步操作成功 */</span>)&#123;</div><div class="line">        resolve(ret);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        reject(error);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">p.then(<span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</div><div class="line">    <span class="comment">// 完成态</span></div><div class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">error</span>) </span>&#123;</div><div class="line">    <span class="comment">// 失败态</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们需要关注的是</p>
<ul>
<li>Promise的构造函数</li>
<li>resolve() ， reject()</li>
<li>then()</li>
</ul>
<h3 id="1-1-Promise构造函数"><a href="#1-1-Promise构造函数" class="headerlink" title="1.1 Promise构造函数"></a>1.1 Promise构造函数</h3><p>我们在通过Promise构造函数实例化一个对象时，会传递一个函数作为参数，那么这个函数有什么特点？</p>
<p>答案就是在新建一个Promise后，这个函数会立即执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">reslove, reject</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'Promise'</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'end'</span>);</div></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<p><img src="/uploads/promise-example-01.png" alt="promise-example-01.png"></p>
<p>可以看到是先输出了<code>Promise</code>，再输出了<code>end</code>。</p>
<h3 id="1-2-resolve-reject"><a href="#1-2-resolve-reject" class="headerlink" title="1.2 resolve/reject"></a>1.2 resolve/reject</h3><p>在Promise中，对一个异步操作做出了抽象的定义，Promise操作只会处在3种状态的一种，他们之间的转化如图所示</p>
<p><img src="/uploads/promise-state.png" alt="promise-state"></p>
<p>注意，这种状态的改变只会出现从未完成态向完成态或失败态转化，不能逆反。完成态和失败态不能互相转化，而且，状态一旦转化，将不能更改。</p>
<p>只有异步操作的结果可以决定当前是哪一种状态，任何其他操作都无法改变这个状态。这也是Promise这个名字的由来，它的英语意思是承诺，表示其他手段无法改变。</p>
<p>在声明一个Promise对象实例时，我们传入的匿名函数参数中：</p>
<ul>
<li><code>resolve</code>就对应着完成态之后的操作</li>
<li><code>reject</code>对应着失败态之后的操作</li>
</ul>
<h3 id="1-3-then"><a href="#1-3-then" class="headerlink" title="1.3 then()"></a>1.3 then()</h3><p>那么问题来了，then()方法有什么作用？resolve和reject又是从哪里传递过来的？</p>
<p>其实这两个问题是一个问题，在实例化一个Promise对象之后，我们调用该对象实例的<code>then()</code>方法传递的两个参数中:</p>
<ul>
<li>第一个参数（函数）对应着完成态的操作，也就是<code>resolve</code></li>
<li>第二个参数（函数）对应着失败态的操作，也就是<code>reject</code></li>
</ul>
<p>那就是说，在Promise中是通过then()方法来指定处理异步操作结果的方法。</p>
<h3 id="1-4-实际案例"><a href="#1-4-实际案例" class="headerlink" title="1.4 实际案例"></a>1.4 实际案例</h3><p>到这里我们明白了Promise的语法，也了解了Promise中函数是如何执行的，结合一个实际的案例，来加深对Promise的理解。</p>
<p>我们来实现一个异步加载图片的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadImageAsync</span>(<span class="params">url</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span> (<span class="params">reslove, reject</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> img = <span class="keyword">new</span> Image();</div><div class="line">        img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            reslove();</div><div class="line">        &#125;</div><div class="line">        img.onerror = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">            reject();</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">"loading image"</span>);</div><div class="line">        img.src = url;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> loadImage1 = loadImageAsync(<span class="string">"https://www.google.co.jp/images/branding/googlelogo/2x/googlelogo_color_272x92dp.png"</span>);</div><div class="line">loadImage1.then(<span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"success"</span>);</div><div class="line">&#125;, <span class="function"><span class="keyword">function</span> <span class="title">fail</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"fail"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> loadImage2 = loadImageAsync(<span class="string">"1.png"</span>);</div><div class="line">loadImage2.then(<span class="function"><span class="keyword">function</span> <span class="title">success</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"success"</span>);</div><div class="line">&#125;, <span class="function"><span class="keyword">function</span> <span class="title">fail</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"fail"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们在chrome中执行，先是传递一个有效的url，再传递一个无效的url，执行的效果为：</p>
<p><img src="/uploads/promise-example-02.png" alt="promise-example-02.png"></p>
<h2 id="2-Promise进阶"><a href="#2-Promise进阶" class="headerlink" title="2. Promise进阶"></a>2. Promise进阶</h2><h3 id="2-1-resolve-reject的参数"><a href="#2-1-resolve-reject的参数" class="headerlink" title="2.1 resolve/reject的参数"></a>2.1 resolve/reject的参数</h3><p><code>reject</code>函数的参数一般来说是Error对象的实例，而<code>resolve</code>函数的参数除了正常的值外，还可能是另一个<code>Promise实例</code>，表示异步操作的结果有可能是一个值，也有可能是另一个异步操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    resolve(p1);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>代码分析：p1和p2都是Promise的实例，p2中的resolve方法将p1作为参数，即一个异步操作的结果是返回另一个异步操作。</p>
<p>注意，这时p1的状态就会传递给p2，也就是说，p1的状态决定了p2的状态，他们之间的关系是</p>
<p><img src="/uploads/promise-resolve.png" alt="promise-resolve.png"></p>
<p>举个例子</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">console</span>.time(<span class="string">'Promise example start'</span>)</div><div class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(<span class="string">'hi'</span>), <span class="number">3000</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(p1), <span class="number">10</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">p2.then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="built_in">console</span>.timeEnd(<span class="string">'Promise example end'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>我们在node环境下运行以上代码，执行结果为：</p>
<p><img src="/uploads/promise-example-03.png" alt="promise-example-03.png"></p>
<p>从执行时间可以看到，p2会等待p1的执行结果，然后再执行，从输出hi可以看到p1完成状态转变之后，传递给resolve(或者reject)的结果会传递给p2中的<code>resolve</code>。</p>
<h3 id="2-2-then"><a href="#2-2-then" class="headerlink" title="2.2 then()"></a>2.2 then()</h3><p>从上面的例子，我们可以了解到then()方法是Promise实例的方法，即<code>Promise.prototype</code>上的，它的作用是为Promise实例添加状态改变时的回调函数，这个方法的第一个参数是<code>resolved</code>状态的回调函数，第二个参数（可选）是<code>rejected</code>状态的回调函数。</p>
<p>那么then()方法的返回值是什么？<code>then</code>方法会返回一个新的Promise实例（注意，不是原来那个Promise，原来那个Promise已经承诺过，此时继续then就需要新的承诺~~），这样的设计的好处就是可以使用链式写法。</p>
<p>还有一个点，就是链式中的<code>then</code>方法（第二个开始），它们的<code>resolve</code>中的参数是什么？答案就是前一个then()中resolve的<code>return</code>语句的返回值。</p>
<p>来一个示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(<span class="string">'p1'</span>), <span class="number">10</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">p1.then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then1'</span>;</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then2'</span>;</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在node环境下执行，执行结果为：</p>
<p><img src="/uploads/promise-example-04.png" alt="promise-example-04.png"></p>
<h3 id="2-3-catch-错误处理"><a href="#2-3-catch-错误处理" class="headerlink" title="2.3 catch()错误处理"></a>2.3 catch()错误处理</h3><p>catch()方法是Promise实例的方法，即<code>Promise.prototype</code>上的属性，它其实是<code>.then(null, rejection)</code>的简写，用于指定发生错误时的回调。</p>
<p>这个方法其实很简单，在这里并不想讨论它的使用，而是想讨论的是Promise中的错误的捕抓和处理。</p>
<h4 id="2-3-1-Error对象的传递性"><a href="#2-3-1-Error对象的传递性" class="headerlink" title="2.3.1 Error对象的传递性"></a>2.3.1 Error对象的传递性</h4><p>Promise对象的Error对象具有<code>冒泡</code>性质，会一直向后传递，直到被捕获为止。也就是说，错误总是会被下一个catch语句捕获，示例代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(<span class="string">'p1'</span>), <span class="number">10</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">p.then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'then1'</span>);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then1'</span>;</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'then2'</span>);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then2'</span>;</div><div class="line">&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    <span class="comment">// 可以捕抓到前面的出现的错误。</span></div><div class="line">    <span class="built_in">console</span>.log(err.toString());</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>执行结果如下</p>
<p><img src="/uploads/promise-example-05.png" alt="promise-example-05.png"></p>
<p>在第一个then中抛出了一个错误，在最后一个Promise对象中可以catch到这个错误。</p>
<p><em>因为有这种方便的错误处理机制，所以一般来说不要在then方法里面定义reject状态的回调函数， 而是使用catch方法</em></p>
<h4 id="2-3-2-vs-try-catch"><a href="#2-3-2-vs-try-catch" class="headerlink" title="2.3.2 vs try/catch"></a>2.3.2 vs try/catch</h4><blockquote>
<p>跟传统的<code>try/catch</code>不同的是，如果没有使用<code>catch</code>方法指定错误处理回调函数，则Promise对象抛出的错误不会传递到外层代码（在chrome会报错）</p>
</blockquote>
<p>Node.js有一个unhandledRejection事件，专门监听未捕获的reject错误。以下代码就是在node环境下运行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    resolve(x + <span class="number">2</span>);</div><div class="line">&#125;);</div><div class="line">p.then( <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'nothing'</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><img src="/uploads/promise-example-06.png" alt="promise-example-06.png"></p>
<h4 id="2-3-3-catch-的返回值"><a href="#2-3-3-catch-的返回值" class="headerlink" title="2.3.3 catch()的返回值"></a>2.3.3 catch()的返回值</h4><p>没错，既然catch()是<code>.then(null, rejection)</code>的别名，那么catch()就会返回一个Promise对象，因此在后面还可以接着调用<code>then</code>方法，示例代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    resolve(x + <span class="number">2</span>);</div><div class="line">&#125;);</div><div class="line">p.then( <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'nothing'</span>);</div><div class="line">&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(err.toString());</div><div class="line">    <span class="keyword">return</span> <span class="string">'catch'</span>;</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><img src="/uploads/promise-example-07.png" alt="promise-example-07.png"></p>
<p>当出错时，catch会先处理之前的错误，然后通过return语句，将值继续传递给后一个then方法中。</p>
<p>如果没有报错，则跳过catch，示例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    resolve(<span class="string">'p'</span>);</div><div class="line">&#125;);</div><div class="line">p.then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then1'</span>;</div><div class="line">&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(err.toString());</div><div class="line">    <span class="keyword">return</span> <span class="string">'catch'</span>;</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><img src="/uploads/promise-example-08.png" alt="promise-example-08.png"></p>
<h2 id="3-Promise对象方法"><a href="#3-Promise对象方法" class="headerlink" title="3. Promise对象方法"></a>3. Promise对象方法</h2><h3 id="3-1-Promise-all"><a href="#3-1-Promise-all" class="headerlink" title="3.1 Promise.all()"></a>3.1 Promise.all()</h3><p>Promise.all()方法用于将多个Promise实例，包装成一个新的Promise实例，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.all([p1, p2, p3]);</div></pre></td></tr></table></figure>
<p>新的Promise实例<code>p</code>的状态由<code>p1, p2, p3</code>决定：</p>
<ul>
<li>当<code>p1, p2, p3</code>的状态都为<code>完成态</code>时，p为完成态。</li>
<li><code>p1, p2, p3</code>中任一一个状态为<code>失败态</code>，则p为失败态。</li>
</ul>
<h3 id="3-2-Promise-race"><a href="#3-2-Promise-race" class="headerlink" title="3.2 Promise.race()"></a>3.2 Promise.race()</h3><p>Promise.race方法同样是将多个Promise实例，包装成一个新的Promise实例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.race([p1, p2, p3]);</div></pre></td></tr></table></figure>
<p>不同的是，只要<code>p1, p2, p3</code>中任意一个实例率先改变状态，则<code>p</code>的状态就跟着改变，而且状态由率先改变的实例决定。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.race([</div><div class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</div><div class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> resolve(<span class="string">'p1'</span>), <span class="number">10000</span>);</div><div class="line">    &#125;),</div><div class="line">    <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'time out'</span>)), <span class="number">10</span>);</div><div class="line">    &#125;)</div><div class="line">]);</div><div class="line">p.then( <span class="function"><span class="params">ret</span> =&gt;</span> <span class="built_in">console</span>.log(ret))</div><div class="line">    .catch( <span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err.toString()));</div></pre></td></tr></table></figure>
<p><img src="/uploads/promise-example-10.png" alt="promise-example-10.png"></p>
<h3 id="3-3-Promise-resolve"><a href="#3-3-Promise-resolve" class="headerlink" title="3.3  Promise.resolve()"></a>3.3  Promise.resolve()</h3><p>Promise.resolve()可以将现有的对象转为Promise对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.resolve(<span class="string">'p'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 相当于</span></div><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> resolve(<span class="string">'p'</span>));</div></pre></td></tr></table></figure>
<p>比较有意思的是Promise.resolve()会根据参数类型进行相应的处理，分几种情况讨论。</p>
<h4 id="3-3-1-Promise实例"><a href="#3-3-1-Promise实例" class="headerlink" title="3.3.1 Promise实例"></a>3.3.1 Promise实例</h4><p>参数是一个Promise实例，那么Promise.resolve将不做任何处理，直接返回这个实例。</p>
<h4 id="3-3-2-thenable对象"><a href="#3-3-2-thenable对象" class="headerlink" title="3.3.2 thenable对象"></a>3.3.2 thenable对象</h4><p>参数是一个<code>thenable</code>对象，也就是说对象是具有<code>then</code>方法的对象，但不是一个Promise实例（就跟类数组和数组的关系一样），例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> thenable = &#123;</div><div class="line">    <span class="attr">then</span> : <span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">        resolve(<span class="number">42</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">let</span> p = <span class="built_in">Promise</span>.resolve(thenable);</div><div class="line">p.then( <span class="function"><span class="params">ret</span> =&gt;</span> <span class="built_in">console</span>.log(ret)); <span class="comment">// 42</span></div></pre></td></tr></table></figure>
<p>Promise.resolve方法会将这个对象转为Promise对象，然后立即执行thenable对象中的then方法，因为例子中的thenable对象的then方法中执行了<code>resolve</code>，因此会输出结果<code>42</code>。</p>
<h4 id="3-3-3-其他参数"><a href="#3-3-3-其他参数" class="headerlink" title="3.3.3 其他参数"></a>3.3.3 其他参数</h4><p>如果参数是一个原始值，或者不具有then方法的对象，则Promise.resolve方法返回一个新的Promise对象，状态为<code>resolve</code>，然后直接将该参数传递给<code>resolve</code>方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.resolve(<span class="string">"p"</span>);</div><div class="line">p.then( <span class="function"><span class="params">ret</span> =&gt;</span> <span class="built_in">console</span>.log(ret)); <span class="comment">// p</span></div></pre></td></tr></table></figure>
<h4 id="3-3-4-不带任何参数"><a href="#3-3-4-不带任何参数" class="headerlink" title="3.3.4 不带任何参数"></a>3.3.4 不带任何参数</h4><p>Promise.resolve方法不带参数时，会直接返回一个<code>resolve</code>状态的Promise对象。</p>
<p>需要注意的立即<code>resolve</code>的Promise对象，是在本轮<code>事件循环</code>的结束时，而不是下一轮<code>事件循环</code>的开始执行。示例代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'3'</span>), <span class="number">0</span>);</div><div class="line"><span class="keyword">var</span> p = <span class="built_in">Promise</span>.resolve();</div><div class="line">p.then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'2'</span>));</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'1'</span>);</div></pre></td></tr></table></figure>
<p>输出结果为：</p>
<p><img src="/uploads/promise-example-11.png" alt="promise-example-11.png"></p>
<h3 id="3-4-Promise-reject"><a href="#3-4-Promise-reject" class="headerlink" title="3.4 Promise.reject()"></a>3.4 Promise.reject()</h3><p>Promise.reject()返回一个新的Promise实例，该实例的状态为<code>rejected</code>，对于传入的参数的处理跟Promise.resolve类似，就是状态都为<code>rejected</code>。</p>
<h2 id="4-两个实用的方法"><a href="#4-两个实用的方法" class="headerlink" title="4. 两个实用的方法"></a>4. 两个实用的方法</h2><h3 id="4-1-done"><a href="#4-1-done" class="headerlink" title="4.1 done()"></a>4.1 done()</h3><p>Promise对象的回调链，不管以then方法或者catch方法结尾，要是最后一个方法抛出错误，都有可能无法捕捉到，因为Promise内部的错误不会冒泡到全局，因此，我们可以提供一个done方法，总是处理回调链的尾端，保证抛出任何可能出现的错误。</p>
<p>这个代码的实现非常简单</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Promise</span>.prototype.done = <span class="function"><span class="keyword">function</span> (<span class="params">resolve, reject</span>) </span>&#123;</div><div class="line">    <span class="keyword">this</span>.then(resolve, reject)</div><div class="line">        .catch( <span class="function"><span class="keyword">function</span> (<span class="params">reason</span>) </span>&#123;</div><div class="line">            <span class="comment">// 抛出一个全局错误</span></div><div class="line">            setTimeout( <span class="function"><span class="params">()</span> =&gt;</span> &#123; <span class="keyword">throw</span> reason &#125;, <span class="number">0</span>);</div><div class="line">        &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 使用示例</span></div><div class="line"><span class="keyword">var</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</div><div class="line">    resolve(<span class="string">'p'</span>);</div><div class="line">&#125;);</div><div class="line">p.then(<span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then1'</span>;</div><div class="line">&#125;).catch( <span class="function"><span class="params">err</span> =&gt;</span> &#123;</div><div class="line">    <span class="built_in">console</span>.log(err.toString());</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">	<span class="built_in">console</span>.log(ret);</div><div class="line">    <span class="keyword">return</span> <span class="string">'then2'</span>;</div><div class="line">&#125;).then( <span class="function"><span class="params">ret</span> =&gt;</span> &#123;</div><div class="line">	<span class="built_in">console</span>.log(ret);</div><div class="line">    x + <span class="number">2</span>;</div><div class="line">&#125;).done();</div></pre></td></tr></table></figure>
<p><img src="/uploads/promise-example-09.png" alt="promise-example-09.png"></p>
<p>这里为什么可以在全局抛出一个错误？原因就是setTimeout中的回调函数是在<code>全局作用域中执行的</code>，因此抛出的错误就是在全局作用域上。</p>
<h3 id="4-2-finally"><a href="#4-2-finally" class="headerlink" title="4.2 finally()"></a>4.2 finally()</h3><p>finally方法用于指定不管Promise对象最后的状态如何，都会执行的操作，它与done方法最大的区别就是，它接受一个普通函数作为参数，该函数不管怎么样都必须执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Promise</span>.prototype.finally = <span class="function"><span class="keyword">function</span> (<span class="params">callback</span>) </span>&#123;</div><div class="line">    <span class="keyword">let</span> P = <span class="keyword">this</span>.constructor;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.then(</div><div class="line">        <span class="function"><span class="params">ret</span> =&gt;</span> P.resolve(callback()).then( <span class="function"><span class="params">()</span> =&gt;</span> ret),</div><div class="line">        err =&gt; P.resolve(callback()).then( <span class="function"><span class="params">()</span> =&gt;</span> &#123;<span class="keyword">throw</span> reason &#125;)</div><div class="line">    );</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="5-Promise的优劣势"><a href="#5-Promise的优劣势" class="headerlink" title="5. Promise的优劣势"></a>5. Promise的优劣势</h2><p>从上面几个小节综合来看，可以看到Promise其实就是做了一件事情，那就是对异步操作进行了封装，然后可以将异步操作以同步的流程表达出来，避免了层层嵌套的回调函数，同时提供统一的接口，使得控制异步操作更加容易。</p>
<p>但是，Promise也有一些缺点：</p>
<ul>
<li>无法取消Promise，一旦新建它就会立即执行，无法中途取消。</li>
<li>如果不设置回调函数，Promise内部的错误不会反应到外部。</li>
<li>当处于未完成态时，无法得知目前进展到哪一个阶段。</li>
</ul>
<h2 id="6-Promise与generator的结合"><a href="#6-Promise与generator的结合" class="headerlink" title="6. Promise与generator的结合"></a>6. Promise与generator的结合</h2><p>使用Generator函数来管理流程，遇到异步操作的时候，通常返回一个<code>Promise</code>对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFoo</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>( <span class="function"><span class="params">resolve</span> =&gt;</span> resolve(<span class="string">'foo'</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> g = <span class="function"><span class="keyword">function</span> * (<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="keyword">var</span> foo = <span class="keyword">yield</span> getFoo();</div><div class="line">		<span class="built_in">console</span>.log(foo);</div><div class="line">	&#125; <span class="keyword">catch</span>(e)&#123;&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">generator</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> it = generator();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params">result</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span>(result.done) <span class="keyword">return</span> result.value;</div><div class="line"></div><div class="line">		<span class="comment">// 默认value是一个Promise，其实这里应该做判断的</span></div><div class="line">		<span class="keyword">if</span>(!(result.value <span class="keyword">instanceof</span> <span class="built_in">Promise</span>))&#123;</div><div class="line">			<span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'yield must follow an instanceof Promise'</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> result.value.then(</div><div class="line">			<span class="function"><span class="params">ret</span> =&gt;</span> go(it.next(ret))</div><div class="line">		).catch(<span class="function"><span class="params">err</span> =&gt;</span> go(it.throw(err)));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	go(it.next());</div><div class="line">&#125;</div><div class="line"></div><div class="line">run(g);</div></pre></td></tr></table></figure>
<p>上面代码的Generator函数g之中，有一个异步操作getFoo，它返回的就是一个Promise对象。函数run用来处理这个Promise对象，并调用下一个next方法。</p>
<h2 id="7-来源"><a href="#7-来源" class="headerlink" title="7. 来源"></a>7. 来源</h2><ol>
<li><a href="http://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="external">ECMAScript 6入门-阮一峰</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/异步编程/" rel="tag"># 异步编程</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/04/class/" rel="next" title="es6系列-class">
                <i class="fa fa-chevron-left"></i> es6系列-class
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/04/generator/" rel="prev" title="es6系列-generator">
                es6系列-generator <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/12/04/promise/"
     data-title="es6系列-promise"
     data-content=""
     data-url="https://zhangguixu.github.io/2016/12/04/promise/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/12/04/promise/"
           data-title="es6系列-promise" data-url="https://zhangguixu.github.io/2016/12/04/promise/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/avatar.jpeg"
               alt="zhangguixu" />
          <p class="site-author-name" itemprop="name">zhangguixu</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">54</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">43</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhangguixu" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              常用网站
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://segmentfault.com/" title="segmentfault" target="_blank">segmentfault</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://gold.xitu.io/welcome" title="掘金" target="_blank">掘金</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.xuanfengge.com/" title="轩枫阁" target="_blank">轩枫阁</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.cnblogs.com/PeunZhang/" title="白色橡树" target="_blank">白色橡树</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.ruanyifeng.com/blog/" title="阮一峰" target="_blank">阮一峰</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://yanhaijing.com/?url_type=39&object_type=webpage&pos=1" title="颜海镜" target="_blank">颜海镜</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.liaoxuefeng.com/" title="廖雪峰" target="_blank">廖雪峰</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.cnblogs.com/pigtail/" title="穆乙" target="_blank">穆乙</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.alloyteam.com/" title="Alloy Team" target="_blank">Alloy Team</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://f2er.club/" title="最牛前端收藏夹" target="_blank">最牛前端收藏夹</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://github.com/icepy/Front-End-Develop-Guide" title="前端开发指南" target="_blank">前端开发指南</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jstips.co/zh_CN/" title="jstips" target="_blank">jstips</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-理解Promise"><span class="nav-text">1. 理解Promise</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-Promise构造函数"><span class="nav-text">1.1 Promise构造函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-resolve-reject"><span class="nav-text">1.2 resolve/reject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-then"><span class="nav-text">1.3 then()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-实际案例"><span class="nav-text">1.4 实际案例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Promise进阶"><span class="nav-text">2. Promise进阶</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-resolve-reject的参数"><span class="nav-text">2.1 resolve/reject的参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-then"><span class="nav-text">2.2 then()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-catch-错误处理"><span class="nav-text">2.3 catch()错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-Error对象的传递性"><span class="nav-text">2.3.1 Error对象的传递性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-vs-try-catch"><span class="nav-text">2.3.2 vs try/catch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-catch-的返回值"><span class="nav-text">2.3.3 catch()的返回值</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Promise对象方法"><span class="nav-text">3. Promise对象方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Promise-all"><span class="nav-text">3.1 Promise.all()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-Promise-race"><span class="nav-text">3.2 Promise.race()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Promise-resolve"><span class="nav-text">3.3  Promise.resolve()</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-1-Promise实例"><span class="nav-text">3.3.1 Promise实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-2-thenable对象"><span class="nav-text">3.3.2 thenable对象</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-3-其他参数"><span class="nav-text">3.3.3 其他参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-3-4-不带任何参数"><span class="nav-text">3.3.4 不带任何参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Promise-reject"><span class="nav-text">3.4 Promise.reject()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-两个实用的方法"><span class="nav-text">4. 两个实用的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-done"><span class="nav-text">4.1 done()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-finally"><span class="nav-text">4.2 finally()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-Promise的优劣势"><span class="nav-text">5. Promise的优劣势</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Promise与generator的结合"><span class="nav-text">6. Promise与generator的结合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-来源"><span class="nav-text">7. 来源</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhangguixu</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhangguixu"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
